<dom-module id="waiting-cell">
  <template>

    <iris-reception-api id="reception" on-bank-changed="bankChange"></iris-reception-api>
    <template is="dom-if" if="[[!icon]]">
      [[time]]
    </template>
    <template is="dom-if" if="[[icon]]">
      <iron-icon style="position: initial;" icon="[[icon]]"></iron-icon>
    </template>
  </template>
  <script>
    Polymer({
      is: 'waiting-cell',
      properties: {
        value: {
          type: Object,
          value: {},
          observer: "_ticketChanged"
        },
        icon: {
          type: Boolean,
          value: false
        }
      },
      bankChange(e) {
        let ticket = e.detail;

        if (ticket.pack_member && ticket.session == this.value.session) {
          (!!this.int_id) && clearInterval(this.int_id);
          this.set('icon', 'social:person');
        }
      },
      _ticketChanged(ticket) {
        (!!this.int_id) && clearInterval(this.int_id);

        let start = ticket.getWaitingTime();
        this.set('icon', false);
        let today = ticket.isToday();

        if (start && today && this.isProcessing(ticket)) {
          this.set('icon', 'social:person');
          return;
        }

        if (!start || !ticket.isToday()) {
          let icon = '';
          _.forEachRight(ticket.history, item => {
            icon = this.getIcon(item.event_name);
            return !icon;
          });
          this.set('icon', icon);
          return;
        }

        this.set('time', start);

        this.int_id = setInterval(() => {
          this.set('time', ticket.getWaitingTime());
        }, 600);
      },
      isProcessing(ticket) {
        let session = ticket.session;
        return !!_.find(this.$.reception.self().bank.list, lt => lt.session == session && lt.state == "processing");

      },
      getIcon(key) {
        return IrisBehaviors.TicketHistoryBehavior._getIcon(key);
      },
      detached() {
        (!!this.int_id) && clearInterval(this.int_id);
      }
    });
  </script>
</dom-module>
