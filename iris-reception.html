<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="cell-models.html">


<dom-module id="iris-reception">
  <template>
    <style>
      :host {
        overflow-y: hidden;
        --iris-table-first-cal: {
          white-space: normal;
          max-width: 250px;
        }
        ;
      }

      .table-wrap,
      #service-table,
      #workstation-table {
        max-height: 500px;
      }

      iron-icon {
        position: inherit;
      }
    </style>
    <iris-currentuser id="user" permissions="{{permissions}}" is-logged="{{logged}}"></iris-currentuser>
    <iris-connection on-connection-restore="connetcionRestored"></iris-connection>
    <iris-workstation id="reception"></iris-workstation>

    <iris-shared-entities namespace="services" value="{{services}}" key="ALL"></iris-shared-entities>

    <h3>Посетители и талоны</h3>
    <paper-input label="Введите название услуги" value="{{searchString}}"></paper-input>
    <div class="table-wrap">
      <iris-table id="service-table" fixed-header fields-model="[[fieldsModel]]" data="[[filter(data,mask)]]"></iris-table>
    </div>

    <h3>Окна</h3>
    <paper-input label="Введите название услуги" value="{{workstationString}}"></paper-input>
    <div class="table-wrap">
      <iris-table id="workstation-table" fixed-header fields-model="[[workstationFieldsModel]]" data="[[filterWS(workstationsData,wsMask)]]"></iris-table>
    </div>

  </template>
  <script>
    Polymer({
      is: 'iris-reception',
      properties: {
        searchString: {
          value: '',
          type: String,
          observer: '_searchStringChanged'
        },
        workstationString: {
          value: '',
          type: String,
          observer: '_workstationStringChanged'
        },
        mask: {
          value: '',
          type: String
        }
      },
      observers: ['_permissionsChanged(permissions.can-manage)'],
      _permissionsChanged(permissions) {
        this.synchronizeData();
      },
      _searchStringChanged() {
        if (this.searchString == '') {
          this.set('mask', this.searchString);
          return
        }
        this.debounce('set-mask', () => this.set('mask', this.searchString), 500)
      },
      _workstationStringChanged(string) {
        if (string == '') {
          this.set('wsMask', string);
          return
        }
        this.debounce('set-ws-mask', () => this.set('wsMask', string.toLowerCase()), 500)
      },
      filter(data, mask) {
        if (!mask) return data;

        return _.filter(data, (item) => ~item.id.toLowerCase().indexOf(mask.toLowerCase()))
      },
      filterWS(data, mask) {
        console.log(mask);
        if (!mask) return data;


        return _.filter(data, (item) => {
          let provides = item.provides;
          let service = _.find(provides, (service_id) => {
            let s = this.services[service_id];
            return ~s.label.toLowerCase().indexOf(mask);
          })

          return !!service;
        })
      },
      ready() {
        this.wsMask = '';
        this.fieldsModel = [{
          field: 'id',
          label: 'Название'
        }, {
          fields: {
            first: 'live-slots',
            second: 'prebook-slots'
          },
          template: 'slashed',
          label: 'Доступно'
        }, {
          fields: {
            first: 'issued-tickets',
            second: 'issued-tickets-services'
          },
          template: 'slashed',
          label: 'Выдано'
        }, {
          fields: {
            first: 'in-room',
            second: 'in-room-services'
          },
          template: 'slashed',
          label: 'В зале'
        }, {
          fields: {
            first: 'waiting',
            second: 'waiting-services'
          },
          template: 'slashed',
          label: 'Ожидают'
        }, {
          fields: {
            first: 'processing',
            second: 'processing-services'
          },
          template: 'slashed',
          label: 'Обслуживаются'
        }, {
          fields: {
            first: 'postponed',
            second: 'postponed-services'
          },
          template: 'slashed',
          label: 'Отложено'
        }, {
          fields: {
            first: 'processed',
            second: 'processed-services'
          },
          template: 'slashed',
          label: 'Обслужено'
        }, {
          fields: {
            first: 'total-live',
            second: 'total-prebook'
          },
          template: 'slashed',
          label: 'Всего'
        }];

        this.workstationFieldsModel = [{
          field: 'label',
          label: 'Название'
        }, {
          field: 'service',
          label: 'Услуга'
        }, {
          field: 'available',
          template: 'marked',
          label: 'Доступно'
        }, {
          field: 'paused',
          template: 'marked',
          label: 'Перерыв'
        }, {
          field: 'active',
          template: 'marked',
          label: 'Включено'
        }, {
          field: 'inactive',
          template: 'marked',
          label: 'Выключено'
        }];
      },
      hasPermissions() {
        let permission = this.permissions['can-manage'];
        return _.reduce(permission, (a, item) => a || item, false);
      },
      getDepartments() {
        let permission = this.permissions['can-manage'];

        return _.reduce(permission, (accum, item, key) => {
          if (item) accum.push(key);
          return accum;
        }, [])
      },
      connetcionRestored() {
        if (this.logged && this.hasPermissions()) this.synchronizeData();
      },
      synchronizeData() {
        if (!this.hasPermissions()) return;
        let init_template = {};

        let poll = () => {
          this.$.reception.getServiceInfo({
            department: this.getDepartments()
          }).then((tickets) => {
            let map = _.transform(this.services, (acc, service, key) => {
              if (tickets[key + '--enum-service']) {
                tickets[key + '--enum-service'].id = this.services[key].label;
                acc.push(tickets[key + '--enum-service']);
              } else {
                acc.push({
                  'id': this.services[key].label
                })
              }
            }, []);

            map = _.sortBy(map, 'id');
            this.set('data', map)
          });

          this.$.reception.getWorkstationInfo({
            department: this.getDepartments()
          }).then((data) => {

            let fields = _.chain(data)
              .sortBy('label')
              .map((item) => {

                item.available = item.state == 'active';
                item.paused = item.state == 'paused';
                item.active = item.state == 'active' || item.state == 'paused';
                item.inactive = item.state == 'inactive';
                item.service = item.current_ticket ? this.services[item.current_ticket.service].label : '';

                return item;
              })
              .value();

            this.set('workstationsData', fields);
          });

          //@NOTE: rewrite this shitcode
          //@NOTE: no timer-polls please
          this.logged && setTimeout(poll, 20000);
        };
        poll();
      }
    });
  </script>
</dom-module>
e>
