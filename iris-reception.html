<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="cell-models.html">
<link rel="import" href="reception-dialog.html">


<dom-module id="iris-reception">
  <template>
    <style>
      :host {
        overflow-y: hidden;
        --iris-table-first-cal: {
          white-space: normal;
          max-width: 250px;
        }
        ;
        --iris-table-cell: {
          cursor: pointer;
        }
        ;
      }

      .table-wrap,
      #service-table,
      #workstation-table {
        max-height: 500px;
      }

      iron-icon {
        position: inherit;
      }
    </style>
    <iris-currentuser id="user" permissions="{{permissions}}" is-logged="{{logged}}"></iris-currentuser>
    <iris-connection on-connection-restore="connetcionRestored"></iris-connection>
    <iris-workstation id="reception"></iris-workstation>

    <iris-shared-entities namespace="services" value="{{services}}" key="ALL"></iris-shared-entities>

    <reception-dialog id="dialog" data="[[cellInfo]]"></reception-dialog>

    <h3>Посетители и талоны</h3>
    <paper-input label="Введите название услуги" value="{{searchString}}"></paper-input>
    <div class="table-wrap">
      <iris-table id="service-table" fixed-header fields-model="[[fieldsModel]]" data="[[filter(data,mask)]]" on-cell-tap="cellTap" on-summary-tap="cellTap" has-summary></iris-table>
    </div>

    <h3>Окна</h3>
    <paper-input label="Введите название услуги" value="{{workstationString}}"></paper-input>
    <div class="table-wrap">
      <iris-table id="workstation-table" fixed-header fields-model="[[workstationFieldsModel]]" data="[[filterWS(workstationsData,wsMask)]]" has-summary></iris-table>
    </div>

  </template>
  <script>
    Polymer({
      is: 'iris-reception',
      properties: {
        searchString: {
          value: '',
          type: String,
          observer: '_searchStringChanged'
        },
        workstationString: {
          value: '',
          type: String,
          observer: '_workstationStringChanged'
        },
        mask: {
          value: '',
          type: String
        }
      },
      observers: ['_permissionsChanged(permissions.can-manage)'],
      _permissionsChanged(permissions) {
        this.synchronizeData();
      },
      _searchStringChanged() {
        if (this.searchString == '') {
          this.set('mask', this.searchString);
          return
        }
        this.debounce('set-mask', () => this.set('mask', this.searchString), 500)
      },
      _workstationStringChanged(string) {
        if (string == '') {
          this.set('wsMask', string);
          return
        }
        this.debounce('set-ws-mask', () => this.set('wsMask', string.toLowerCase()), 500)
      },
      cellTap(e) {
        let detail = e.detail;
        if (detail.col < 2) return false;

        let fields = detail.model.fields;
        let row = detail.row;
        let service = row ? _.get(this.$['service-table'], ['data', row, 'id']) : undefined;
        let names = _.values(fields);
        this.$.reception.getServiceDetails({
          param_names: names,
          service: service,
          department: this.getDepartments()
        }).then((response) => {
          let service_label = service ? _.get(this.services, [service, 'label']) : false;
          _.forEach(response, item => item.service = service_label ? service_label : _.get(this.services, [item.service, 'label']));
          this.set('cellInfo', response);
          this.$.dialog.open();
        });
      },
      filter(data, mask) {
        if (!mask) return data;

        return _.filter(data, (item) => ~item.label.toLowerCase().indexOf(mask.toLowerCase()))
      },
      filterWS(data, mask) {
        if (!mask) return data;

        let fields = _.filter(data, (item) => {
          let provides = item.provides;
          let service = _.find(provides, (service_id) => {
            let s = this.services[service_id];
            return ~s.label.toLowerCase().indexOf(mask);
          });
          return !!service;
        });

        return fields;
      },
      ready() {
        this.wsMask = '';
        let slashed_sum = function(acc, v) {
          if (_.get(v, 'first')) acc.first = !!acc.first ? acc.first + v.first : v.first;
          if (_.get(v, 'second')) acc.second = !!acc.second ? acc.second + v.second : v.second;
          return acc;
        };
        this.fieldsModel = [{
          field: 'label',
          label: 'Название',
          reducer: ''
        }, {
          fields: {
            first: 'live-slots',
            second: 'prebook-slots'
          },
          template: 'slashed',
          summary: 'slashed',
          reducer: slashed_sum,
          initial: {},
          label: 'Доступно'
        }, {
          fields: {
            first: 'issued-tickets',
            second: 'issued-tickets-services'
          },
          template: 'slashed',
          summary: 'slashed',
          reducer: slashed_sum,
          initial: {},
          label: 'Выдано'
        }, {
          fields: {
            first: 'in-room',
            second: 'in-room-services'
          },
          template: 'slashed',
          summary: 'slashed',
          reducer: slashed_sum,
          initial: {},
          label: 'В зале'
        }, {
          fields: {
            first: 'waiting',
            second: 'waiting-services'
          },
          template: 'slashed',
          summary: 'slashed',
          reducer: slashed_sum,
          initial: {},
          label: 'Ожидают'
        }, {
          fields: {
            first: 'processing',
            second: 'processing-services'
          },
          template: 'slashed',
          summary: 'slashed',
          reducer: slashed_sum,
          initial: {},
          label: 'Обслуживаются'
        }, {
          fields: {
            first: 'postponed',
            second: 'postponed-services'
          },
          template: 'slashed',
          summary: 'slashed',
          reducer: slashed_sum,
          initial: {},
          label: 'Отложено'
        }, {
          fields: {
            first: 'processed',
            second: 'processed-services'
          },
          template: 'slashed',
          summary: 'slashed',
          reducer: slashed_sum,
          initial: {},
          label: 'Обслужено'
        }, {
          fields: {
            first: 'total-live',
            second: 'total-prebook'
          },
          template: 'slashed',
          summary: 'slashed',
          reducer: slashed_sum,
          initial: {},
          label: 'Всего'
        }];

        let summ = function(acc, v) {
          v && acc++;
          return acc;
        };
        this.workstationFieldsModel = [{
          field: 'label',
          label: 'Название',
          reducer: ''
        }, {
          field: 'service',
          label: 'Услуга',
          reducer: '-'
        }, {
          field: 'available',
          template: 'marked',
          label: 'Доступно',
          reducer: summ
        }, {
          field: 'paused',
          template: 'marked',
          label: 'Перерыв',
          reducer: summ
        }, {
          field: 'active',
          template: 'marked',
          label: 'Включено',
          reducer: summ
        }, {
          field: 'inactive',
          template: 'marked',
          label: 'Выключено',
          reducer: summ
        }];
      },
      hasPermissions() {
        let permission = this.permissions['can-manage'];
        return _.reduce(permission, (a, item) => a || item, false);
      },
      getDepartments() {
        let permission = this.permissions['can-manage'];

        return _.reduce(permission, (accum, item, key) => {
          if (item) accum.push(key);
          return accum;
        }, [])
      },
      connetcionRestored() {
        if (this.logged && this.hasPermissions()) this.synchronizeData();
      },
      synchronizeData() {
        if (!this.hasPermissions()) return;
        let init_template = {};

        let poll = () => {
          this.$.reception.getServiceInfo({
            department: this.getDepartments()
          }).then((tickets) => {
            let map = _.transform(this.services, (acc, service, key) => {
              let row = tickets[key + '--enum-service'] || {};
              row.label = this.services[key].label;
              row.id = key;

              acc.push(row);
            }, []);

            map = _.sortBy(map, 'label');
            this.set('data', map)
          });

          this.$.reception.getWorkstationInfo({
            department: this.getDepartments()
          }).then((data) => {

            let fields = _.chain(data)
              .sortBy('label')
              .map((item) => {

                item.available = item.state == 'active';
                item.paused = item.state == 'paused';
                item.active = item.state == 'active' || item.state == 'paused';
                item.inactive = item.state == 'inactive';
                item.service = item.current_ticket ? this.services[item.current_ticket.service].label : '';

                return item;
              })
              .value();

            this.set('workstationsData', fields);
          });

          //@NOTE: rewrite this shitcode
          //@NOTE: no timer-polls please
          this.logged && setTimeout(poll, 20000);
        };
        poll();
      }
    });
  </script>
</dom-module>
