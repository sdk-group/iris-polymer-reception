<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="cell-models.html">


<dom-module id="iris-reception">
  <template>
    <style>
      :host {
        @apply(--layout-vertical);
        height: 100%;
        overflow-y: hidden;
        --iris-table-first-cal: {
          white-space: normal;
          max-width: 250px;
        }
        ;
      }
      
      iris-table {
        overflow-y: scroll;
        height: 100%;
      }
    </style>
    <iris-currentuser id="user" permissions="{{permissions}}" is-logged="{{logged}}"></iris-currentuser>
    <iris-connection on-connection-restore="connetcionRestored"></iris-connection>
    <iris-workstation id="reception"></iris-workstation>

    <iris-shared-entities namespace="services" value="{{services}}" key="ALL"></iris-shared-entities>
    <paper-input label="Введите название услуги" value="{{searchString}}"></paper-input>

    <div id="service-wrap">
      <iris-table id="service-table" fixed-header fields-model="[[fieldsModel]]" data="[[filter(data,mask)]]"></iris-table>
    </div>

    <div>
      <iris-table id="workstation-table" fixed-header fields-model="[[workstationFieldsModel]]"></iris-table>
    </div>

  </template>
  <script>
    Polymer({
      is: 'iris-reception',
      properties: {
        searchString: {
          value: '',
          type: String,
          observer: '_searchStringChanged'
        },
        mask: {
          value: '',
          type: String
        }
      },
      observers: ['_permissionsChanged(permissions.can-manage)'],
      _permissionsChanged(permissions) {
        this.synchronizeData();
      },
      _searchStringChanged() {
        if (this.searchString == '') {
          this.set('mask', this.searchString);
          return
        }
        this.debounce('set-mask', () => this.set('mask', this.searchString), 500)
      },
      filter(data, mask) {
        if (!mask) {
          return data;
        }
        return _.filter(data, (item) => ~item.id.toLowerCase().indexOf(mask.toLowerCase()))
      },
      ready() {
        this.workstationFieldsModel = [];

        this.fieldsModel = [{
          field: 'id',
          label: 'Название'
        }, {
          fields: {
            first: 'live-slots',
            second: 'prebook-slots'
          },
          template: 'slashed',
          label: 'Доступно'
        }, {
          fields: {
            first: 'issued-tickets',
            second: 'issued-tickets-services'
          },
          template: 'slashed',
          label: 'Выдано'
        }, {
          fields: {
            first: 'in-room',
            second: 'in-room-services'
          },
          template: 'slashed',
          label: 'В зале'
        }, {
          fields: {
            first: 'waiting',
            second: 'waiting-services'
          },
          template: 'slashed',
          label: 'Ожидают'
        }, {
          fields: {
            first: 'processing',
            second: 'processing-services'
          },
          template: 'slashed',
          label: 'Обслуживаются'
        }, {
          fields: {
            first: 'postponed',
            second: 'postponed-services'
          },
          template: 'slashed',
          label: 'Отложено'
        }, {
          fields: {
            first: 'processed',
            second: 'processed-services'
          },
          template: 'slashed',
          label: 'Обслужено'
        }, {
          fields: {
            first: 'total-live',
            second: 'total-prebook'
          },
          template: 'slashed',
          label: 'Всего'
        }];
      },
      hasPermissions() {
        let permission = this.permissions['can-manage'];
        return _.reduce(permission, (a, item) => a || item, false);
      },
      getDepartments() {
        let permission = this.permissions['can-manage'];

        return _.reduce(permission, (accum, item, key) => {
          if (item) accum.push(key);
          return accum;
        }, [])
      },
      connetcionRestored() {
        if (this.logged && this.hasPermissions()) this.synchronizeData();
      },
      synchronizeData() {
        if (!this.hasPermissions()) return;
        let init_template = {};
        console.log('Sync data here');
        let poll = () => {
          Promise.props({
            slots: this.$.reception.getAvailableSlots(),
            tickets: this.$.reception.getServiceInfo({
              department: this.getDepartments()
            })
          }).then(({
            slots,
            tickets
          }) => {
            let map = [];
            let now = moment().format('YYYY-MM-DD');

            _.forEach(this.services, (service, key) => {
              let slot = _.get(slots, [key, now, 'available_slots']) || {};

              if (tickets[key + '--enum-service']) {
                tickets[key + '--enum-service'].id = this.services[key].label;
                tickets[key + '--enum-service']['live-slots'] = slot.live;
                tickets[key + '--enum-service']['prebook-slots'] = slot.prebook;
                map.push(tickets[key + '--enum-service']);
              } else {
                map.push({
                  'live-slots': slot.live,
                  'prebook-slots': slot.prebook,
                  'id': this.services[key].label
                })
              }
            });
            // console.log(map);
            map = _.sortBy(map, 'id');
            this.set('data', map)
          });
          //@NOTE: rewrite this shitcode
          //@NOTE: no timer-polls please
          this.logged && setTimeout(poll, 20000);
        };
        poll();
      }
    });
  </script>
</dom-module>